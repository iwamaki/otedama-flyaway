# Otedama Flyaway ステージ設計ガイド

## 物理制約

### ジャンプ高さ
```
単発スワイプ最大: 14マス
二段発射最大:     23マス

座標系: y小=上、y大=下
```

### 難易度記号
| 記号 | 高さ差 | 必要スキル | 説明 |
|------|--------|------------|------|
| 緩 | 0-12m | 単発（余裕） | 誰でもできる |
| 急 | 12-14m | 単発（精密） | 力加減が必要 |
| 超急 | 15-23m | 二段発射 | 空中で追加スワイプ必須 |

---

## 設計哲学

### Jump King スタイル
```
特徴:
├─ 閉鎖型環境（左右に壁）
├─ 吹き抜け構造（途中の床なし）
├─ 落ちても死なない（最下層に戻るだけ）
└─ ペナルティは「時間ロス」のみ

利点:
├─ 安心して練習できる
├─ 失敗しても再挑戦しやすい
└─ ハラハラ感は「落ちたら戻される」で実現
```

### 緩急のリズム
```
悪い例: 緩緩緩緩急緩緩緩緩急
        → 単調、退屈

良い例: 緩→急→緩→緩→急→緩→急
        → リズムがある、メリハリ

原則:
├─ 急の後には緩を入れる（休憩）
├─ 緩が続きすぎない（2-3個まで）
├─ 超急は1ステージに1-2回（スパイス）
└─ 最後は急で締める（達成感）
```

---

## ASCII設計テンプレート

### 基本構造
```
     x: -50  -40      -20        0       +20      +40  +50
        |####|                                   |####|
   -24  |####|============[遷移ゾーン]=============|####|  ← 壁から壁まで
        |####|                                   |####|
   -18  |####|            [==ゴール==]           |####|  T 中央
        |####|                 ↑                 |####|
        |####|                 |10m              |####|
        |####|                                   |####|
    -8  |####|        [P]            [P]         |####|  P 並列
        |####|                                   |####|
        ...
        |####|                                   |####|
    44  |####|======[=====T/スポーン=====]======|####|  T 両壁接続
        |####|           S                       |####|
        |####|                                   |####|
    60  |####|=================床=================|####|  床（最下層のみ）
        └────┴───────────────────────────────────┴────┘

プレイエリア: 80マス幅（-40〜+40）
壁: 各10マス厚（-50〜-40, +40〜+50）
```

### 記号凡例
```
足場タイプ:
├─ T  : Terrain（広い・安心）- 休憩、スポーン、ゴール
└─ P  : Platform（細い・緊張）- 挑戦、スキル要求

構造記号:
├─ |####| : 壁（terrain/rock）
├─ ====   : 足場・床
├─ [==]   : 足場（幅を示す）
├─ S      : スポーン位置
├─ ↑↗↖   : ジャンプ方向
└─ 12m    : ジャンプ高さ（マス数）

壁接続パターン:
├─ |####============[足場]           : 左壁に接続
├─ |####|       [足場]========|####| : 右壁に接続
├─ |####|======[足場]=========|####| : 両壁に接続
└─ |####|       [足場]        |####| : 浮き（接続なし）

ギミック:
├─ [TR]  : トランポリン
└─ [ICE] : 氷床
```

---

## ステージ構成

### ワールド構成案
```
ワールド1: チュートリアル（wood）
├─ 1-1: 基本操作（単発ジャンプ）
├─ 1-2: 二段発射の導入
└─ 1-3: 横距離ジャンプ

ワールド2: 本格ステージ
├─ 2-1〜: 学んだ技術の組み合わせ
└─ 難易度徐々に上昇

ワールド3以降: 応用・高難度
```

### 学習曲線の原則
```
各ステージ内:
1. 導入部: 簡単な緩ジャンプで成功体験
2. 学習部: 新しい技術を急ジャンプで学ぶ
3. 練習部: 緩ジャンプで練習
4. 確認部: 急ジャンプで習熟を確認

ステージ間:
├─ 前ステージで学んだ技術は当然として使う
├─ 新しい技術を1つずつ追加
└─ 復習と新規のバランス
```

---

## ステージオブジェクト一覧

### 実装済みオブジェクト

#### terrain（地形）
```
用途: 壁、床、足場など自由形状の地形
特徴: ChainShapeで凹型対応、terrainTypeで物理特性変更

★座標の書き方:
├─ x, y は常に 0, 0 にする（原点固定）
├─ vertices にワールド座標を直接記述
└─ 頂点座標 = そのままワールド上の位置

terrainType一覧:
├─ grass    : 草地（friction: 0.5, restitution: 0.2）
├─ dirt     : 土（friction: 0.5, restitution: 0.2）
├─ rock     : �ite（friction: 0.6, restitution: 0.3）
├─ wood     : 木（friction: 0.7, restitution: 0.25）
├─ ice      : 氷（friction: 0.02, restitution: 0.1）★滑る
├─ metal    : 金属（friction: 0.3, restitution: 0.4）
├─ snow     : 雪（friction: 0.5, restitution: 0.2）
├─ snowIce  : 雪氷（friction: 0.05, restitution: 0.1）★やや滑る
└─ stoneTiles: 石タイル（friction: 0.6, restitution: 0.3）
```
```json
// 例: x=5〜15, y=18〜22 の範囲に足場を配置
{
  "type": "terrain",
  "x": 0, "y": 0,
  "vertices": [
    {"x": 5, "y": 18},
    {"x": 15, "y": 18},
    {"x": 15, "y": 22},
    {"x": 5, "y": 22}
  ],
  "isLoop": true,
  "terrainType": "grass"
}
```

#### platform（足場）
```
用途: シンプルな矩形足場
特徴: 木目模様、サイズ変更可能
```
```json
{
  "type": "platform",
  "x": 0, "y": 0,
  "width": 6, "height": 1,
  "angle": 0
}
```

### T（Terrain）vs P（Platform）の使い分け

```
【設計思想】
├─ T（Terrain）: 安心感を与える、大きめの地形
├─ P（Platform）: スキルを要求する、細めの足場
└─ 使い分けでメリハリを出す

【T（Terrain）を使う場面】
├─ スポーン地点（安心して始められる）
├─ 休憩ポイント（急の後の緩）
├─ 最上部（次ステージへの遷移前）
├─ 床・壁（基盤構造）
├─ サイズ目安: 幅10以上、高さ3〜4
└─ 圧迫感なく「ここは安全」と伝える

【P（Platform）を使う場面】
├─ スキル要求（急・超急への踏み切り）
├─ 緊張感を演出したい場所
├─ 着地精度を要求する場所
├─ サイズ目安: 幅5〜6、高さ1
└─ 「慎重に」と伝える

【壁接続の使い分け】
├─ 両壁接続: 床のみ（最下層の安全ネット）
├─ 片壁接続: スポーン、救済用（端に落ちてもキャッチ）
└─ 浮き: 緊張感を演出（落ちたら下の足場へ）

【バランス例】
├─ 緩: T（広くて安心）
├─ 急: P → T（挑戦→休憩）
└─ 超急: P → P（緊張が続く）
```

### 壁の設計ガイドライン

```
【問題】
薄い壁だとステージ外の空間が見えてしまう

【対策】
├─ 壁の厚さは最低10マス以上
├─ 画面外まで壁が続くように設計
└─ 壁の内側に「####」で表現される領域を確保

【推奨サイズ】
├─ 幅: 10マス
├─ 高さ: ステージ全体をカバー
└─ 配置: 左右対称（x=-50〜-40, x=+40〜+50）

【視覚効果】
├─ 厚い壁 → 洞窟・峡谷のような閉鎖感
├─ 薄い壁 → 不自然、没入感を損なう
└─ 壁の terrainType で雰囲気を変える（rock, wood など）
```

#### trampoline（トランポリン）
```
用途: お手玉を強く弾き上げる
特徴: バネ表現、bounceForceで跳ね力調整
デフォルト: bounceForce: 120
```
```json
{
  "type": "trampoline",
  "x": 0, "y": 0,
  "width": 6, "height": 0.4,
  "bounceForce": 120
}
```

#### iceFloor（氷床）
```
用途: 滑る足場
特徴: friction: 0.01、キラキラアニメーション
```
```json
{
  "type": "iceFloor",
  "x": 0, "y": 0,
  "width": 5, "height": 0.4,
  "friction": 0.01
}
```

#### goal（ゴール籠）
```
用途: ゲームクリア地点（最終ステージのみに配置）
特徴: 竹籠風デザイン、入るとゲームクリア
注意: 途中のステージには配置しない
```
```json
{
  "type": "goal",
  "x": 0, "y": 0,
  "width": 4, "height": 3
}
```

#### transitionZone（遷移ゾーン）
```
用途: ステージ間遷移
特徴: センサー、双方向リンク可能

★配置の原則:
├─ 壁から壁まで（横幅いっぱい、幅80マス）
├─ 水平配置（横長）: 落下で通過できるように
├─ 上部遷移ゾーン: ステージ上端近くに配置（上昇で進む）
├─ 下部遷移ゾーン: ステージ下端に配置（落下で戻る）
└─ 下部遷移ゾーンの下には床を置かない（遷移先へ落ちる）

プロパティ:
├─ id: このゾーンの一意ID
├─ nextStage: 遷移先ステージのパス
└─ targetZoneId: 遷移先ゾーンのID

※respawnSide/respawnX/respawnY は不要
  （奈落がないため、遷移先の spawnX/spawnY を使用）
```
```json
// 例: ステージ上部の遷移ゾーン（次ステージへ）
{
  "type": "transitionZone",
  "x": 0, "y": -24,
  "width": 80, "height": 5,
  "nextStage": "assets/stages/stage1-2.json",
  "id": "zone_1_1_top",
  "targetZoneId": "zone_1_2_bottom"
}

// 例: ステージ下部の遷移ゾーン（前ステージへ戻る）
// ★この下には床を置かない！
{
  "type": "transitionZone",
  "x": 0, "y": 60,
  "width": 80, "height": 5,
  "nextStage": "assets/stages/stage1-1.json",
  "id": "zone_1_2_bottom",
  "targetZoneId": "zone_1_1_top"
}
```

#### image_object（画像オブジェクト）
```
用途: 画像から物理形状を自動生成
特徴: 凹型対応、スケール・反転可能
必須: assets/physics/に同名JSONが必要
```
```json
{
  "type": "image_object",
  "imagePath": "stage_objects/rock1.png",
  "x": 0, "y": 0,
  "scale": 0.05,
  "flipX": false, "flipY": false
}
```

---

### 追加予定オブジェクト（20種）

#### 優先度★★★（簡単＆効果大）
| オブジェクト | 説明 | 実装方法 |
|------------|------|---------|
| バンパー | ピンボール風、強反発 | restitution: 1.2 + impulse |
| 跳ね返り壁 | 斜めで方向を変える | restitution: 0.8-1.0 |
| 粘着床 | 動きが鈍くなる | friction: 5.0+ / linearDamping |

#### 優先度★★（中程度）
| オブジェクト | 説明 | 実装方法 |
|------------|------|---------|
| 移動足場 | 左右or上下に往復 | kinematic + 経路 |
| 送風機 | エリア内で風力 | エリア内force適用 |
| 壊れる床 | 乗ると崩壊 | タイマー後remove |
| コンベアベルト | 自動で運ばれる | surface velocity |
| 回転風車 | 当たると弾き飛ばす | kinematic回転 |

#### 優先度★（複雑だが面白い）
| オブジェクト | 説明 | 実装方法 |
|------------|------|---------|
| ワープポータル | A→B瞬間移動 | ペア設置、位置テレポート |
| スイッチ＆扉 | 連動ギミック | センサー + アニメーション |
| 水面エリア | 浮力+抵抗 | buoyancy + drag |
| 磁石 | 引き寄せ | 距離に応じたforce |
| シーソー | 重さでバランス | RevoluteJoint + dynamic |
| 揺れる振り子 | タイミング障害 | RevoluteJoint |
| 回転ドア | 押すと回転 | RevoluteJoint（自由回転） |
| 落とし穴 | リスポーン | センサー → respawn |

#### 装飾系
| オブジェクト | 説明 | 実装方法 |
|------------|------|---------|
| 和風提灯 | 装飾+軽い衝突 | 揺れアニメーション |
| 竹林障害物 | 隙間を縫う | 細い柱の集合 |

---

## 遷移ゾーン設計

### 吹き抜け構造の概念
```
ワールドは縦につながった「吹き抜けの塔」:
├─ 各ステージに床はない（最下層のみ）
├─ 遷移ゾーンは壁から壁まで（横幅いっぱい）
├─ 落下したら遷移ゾーンを通過して下のステージへ
└─ 最悪の場合、最下層の床まで落ちる

    ┌─────────────────────────────────────────────┐
    │              ステージ1-3                     │
    │         足場...                             │
    │=============================================│ zone（壁から壁）
    ─────────────────────────────────────────────────  ← 床なし！
    │=============================================│ zone（壁から壁）
    │              ステージ1-2                     │
    │         足場...                             │
    │=============================================│ zone（壁から壁）
    ─────────────────────────────────────────────────  ← 床なし！
    │=============================================│ zone（壁から壁）
    │              ステージ1-1                     │
    │         足場...                             │
    │=============================================│ 床（唯一の安全ネット）
    └─────────────────────────────────────────────┘

スリル:
├─ 上のステージで失敗 → 遷移ゾーン通過 → 下のステージへ
├─ 連続で失敗 → 最下層まで落ちる可能性
└─ 床があるのは最下層のみ（安全ネット）
```

### 遷移ゾーンの配置ルール
```
【壁から壁まで】
├─ 幅: プレイエリア全体（80マス）
├─ 高さ: 5マス程度
└─ 遷移ゾーンの向こう側にオブジェクトを置かない

【上部遷移ゾーン】
├─ ステージ上端に配置
├─ 上昇で次のステージへ進む
└─ 最上部足場の上に配置

【下部遷移ゾーン】
├─ ステージ下端に配置
├─ 落下で前のステージへ戻る
├─ この下には床を置かない！
└─ スポーン足場の下に配置

【最下層のみ】
├─ 下部遷移ゾーンの代わりに床を配置
└─ 安全ネットとして機能
```

### ★遷移前後の足場配置（重要）
```
【原則】
遷移時に相対座標（x位置）が保持される。
そのため、遷移前後の足場は物理的につながっていると考えて設計する。

【問題】
遷移前の最上部足場と遷移後のスポーン足場が同じx座標だと、
上昇遷移時に頭をぶつけて乗れない。

    1-2: スポーン x=0 ← 同じx座標だと乗れない！
            ↑
         遷移ゾーン
            ↑ x=0で出る（上昇中）
    --- 遷移 ---
         遷移ゾーン
            ↑ x=0でジャンプ通過
    1-1: 最上部 x=0

【解決策】
遷移前後の足場のx座標をずらす。
斜めジャンプで遷移し、遷移後の足場に自然に乗れるようにする。

    1-2: スポーン x=15 ← 右にずらす
            ↖
         遷移ゾーン
            ↑ x=0→x=15方向へ斜めジャンプ
    --- 遷移 ---
         遷移ゾーン
            ↗ 斜めジャンプ
    1-1: 最上部 x=0

【設計ルール】
├─ 遷移前の最上部足場と遷移後のスポーン足場は x座標を10〜15マスずらす
├─ 最上部から斜めジャンプで遷移ゾーンを通過する設計
├─ 遷移後のスポーン足場は、斜めジャンプの軌道上に配置
├─ ステージ間で左右交互にずらすとリズムが生まれる
│   例: 1-1→1-2は右へ、1-2→1-3は左へ
└─ スポーン足場は広め（両壁接続 or 片壁接続）にして着地しやすく

【ステージ間の連続性イメージ】
    1-3: スポーン x=-15 (左寄り)
            ↖
    ════════════════════════════════  zone
    1-2: 最上部 x=0 (中央)
            ...
    1-2: スポーン x=15 (右寄り)
            ↗
    ════════════════════════════════  zone
    1-1: 最上部 x=0 (中央)
```

### 命名規則
```
id形式: zone_{ワールド}_{ステージ}_{top/bottom}

例:
├─ zone_1_1_top    : 1-1の上部（1-2への出入口）
├─ zone_1_2_bottom : 1-2の下部（1-1への出入口）
├─ zone_1_2_top    : 1-2の上部（1-3への出入口）
└─ zone_1_3_bottom : 1-3の下部（1-2への出入口）
```

---

## チェックリスト

### 設計時
- [ ] 最大ジャンプ高さが14m（単発）or 23m（二段）以内
- [ ] 緩急のリズムがある
- [ ] T/Pの使い分けでメリハリがある
- [ ] 最下層にのみ床がある（安全ネット）
- [ ] 遷移ゾーンが壁から壁まで（幅80マス）
- [ ] 下部遷移ゾーンの下に床がない
- [ ] 遷移ゾーンのid/targetZoneIdが正しくペアリング
- [ ] 壁接続の足場で端落ちを救済
- [ ] spawnX/spawnYが安全な場所（T足場の上）

### 実装後
- [ ] 全ルートがクリア可能
- [ ] 難易度が想定通り
- [ ] 落下時に遷移ゾーンを通過して前ステージに戻る
- [ ] 上昇時に遷移ゾーンを通過して次ステージに進む
- [ ] 吹き抜け構造として自然に機能
- [ ] 端に落ちても壁接続足場でキャッチされる
